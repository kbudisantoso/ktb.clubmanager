// ktb.clubmanager Database Schema
// Documentation: docs/schema/

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// A club or organization managed by the system (tenant).
/// Each club is completely isolated - members, accounts, and transactions
/// belong to exactly one club.
model Club {
  /// Unique identifier (CUID format)
  id          String    @id @default(cuid())
  /// Display name of the club
  name        String
  /// Optional description or notes about the club
  description String?

  /// Soft deletion timestamp (null if not deleted)
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  members     Member[]
  accounts    Account[]

  @@map("clubs")
}

/// Status of a club member
enum MemberStatus {
  /// Currently active member with full privileges
  ACTIVE
  /// Temporarily inactive (e.g., sabbatical)
  INACTIVE
  /// Application pending approval
  PENDING
  /// Left the club (historical record)
  LEFT
}

/// A member of a club with contact information and membership details.
/// Members belong to exactly one club (tenant isolation).
model Member {
  /// Unique identifier (CUID format)
  id          String       @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId      String
  /// The club this member belongs to
  club        Club         @relation(fields: [clubId], references: [id])

  /// Member's full name
  name        String
  /// Email address (unique within club)
  email       String?
  /// Phone number
  phone       String?

  /// Street address
  street      String?
  /// Postal/ZIP code
  postalCode  String?
  /// City
  city        String?

  /// Current membership status
  status      MemberStatus @default(ACTIVE)
  /// Date when member joined the club
  joinedAt    DateTime?
  /// Date when member left (if status is LEFT)
  leftAt      DateTime?

  /// Soft deletion timestamp
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([clubId, email])
  @@index([clubId])
  @@map("members")
}

/// Type of account in the chart of accounts (SKR42)
enum AccountType {
  /// Assets (Aktivkonten) - Class 0-1
  ASSET
  /// Liabilities (Passivkonten) - Class 2-3
  LIABILITY
  /// Income (Ertragskonten) - Class 4
  INCOME
  /// Expense (Aufwandskonten) - Class 5-8
  EXPENSE
}

/// An account in the chart of accounts (Kontenrahmen).
/// Based on SKR42 for German non-profit organizations.
model Account {
  /// Unique identifier (CUID format)
  id          String      @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId      String
  /// The club this account belongs to
  club        Club        @relation(fields: [clubId], references: [id])

  /// SKR42 account code (e.g., "1200" for Bank)
  code        String
  /// Account name/description
  name        String
  /// Type of account (asset, liability, income, expense)
  type        AccountType

  /// Whether this account is active and can receive postings
  isActive    Boolean     @default(true)

  /// Soft deletion timestamp
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([clubId, code])
  @@index([clubId])
  @@map("accounts")
}

// =============================================================================
// Authentication Models
// =============================================================================
// These models support Auth.js (NextAuth.js v5) with Prisma adapter.
// User linking to GoTrue IdP is via externalId (GoTrue user UUID).
// Reference: https://authjs.dev/reference/adapter/prisma

/// Application user. Links to GoTrue via externalId.
/// Soft-deletion supported per CONV-006.
model User {
  id            String    @id @default(cuid())

  /// GoTrue user UUID (from OIDC profile.sub claim)
  /// Used to link app user to identity provider
  externalId    String?   @unique

  /// User's email address (from GoTrue or registration)
  email         String    @unique

  /// Display name (from GoTrue profile or user-provided)
  name          String?

  /// Email verification timestamp (set when email confirmed)
  emailVerified DateTime?

  /// Profile image URL (from OAuth provider or uploaded)
  image         String?

  /// Terms & Conditions acceptance timestamp
  termsAcceptedAt DateTime?

  /// Soft-deletion fields (CONV-006)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  deletedBy     String?

  /// Auth.js relations
  oauthAccounts OAuthAccount[]
  sessions      Session[]

  @@map("users")
}

/// OAuth account linked to a user (Auth.js adapter requirement)
/// Stores tokens and provider info for each linked OAuth account
/// Note: Named OAuthAccount to avoid conflict with Chart of Accounts model
model OAuthAccount {
  id                String  @id @default(cuid())
  userId            String

  /// OAuth provider type (usually "oidc" for GoTrue)
  type              String

  /// Provider identifier (e.g., "gotrue", "google")
  provider          String

  /// Provider's account ID (GoTrue user UUID for OIDC)
  providerAccountId String

  /// OAuth tokens (snake_case per Auth.js convention)
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

/// User session (Auth.js adapter requirement)
/// Database-backed sessions for revocation support
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// Email verification token (Auth.js adapter requirement)
/// Used for magic link authentication
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
