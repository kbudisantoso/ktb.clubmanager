// ktb.clubmanager Database Schema
// Documentation: docs/schema/

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

/// A club or organization managed by the system (tenant).
/// Each club is completely isolated - members, accounts, and transactions
/// belong to exactly one club.
model Club {
  /// Unique identifier (CUID format)
  id          String  @id @default(cuid())
  /// Display name of the club (2-100 chars)
  name        String
  /// Legal/official name (up to 255 chars)
  legalName   String?
  /// URL-safe identifier (3-50 chars, unique)
  slug        String  @unique
  /// Optional description or notes about the club
  description String?

  /// Club visibility (PUBLIC = searchable, PRIVATE = invite-only)
  visibility ClubVisibility @default(PRIVATE)
  /// 8-char code for joining (XXXX-XXXX format stored without dash)
  inviteCode String?        @unique

  /// Avatar: either image URL or initials + color
  avatarUrl      String?
  /// 1-3 characters for avatar display
  avatarInitials String?
  /// Preset color name for avatar
  avatarColor    String?

  /// Tier for feature limits (optional)
  tierId String?
  tier   Tier?   @relation(fields: [tierId], references: [id])

  /// Soft deletion timestamp (null if not deleted)
  deletedAt DateTime?
  /// User ID who performed the soft deletion
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clubUsers      ClubUser[]
  accessRequests AccessRequest[]
  members        Member[]
  households     Household[]
  numberRanges   NumberRange[]
  ledgerAccounts LedgerAccount[]

  @@map("clubs")
}

/// Club visibility setting
enum ClubVisibility {
  /// Searchable in app, anyone can request access
  PUBLIC
  /// Hidden, requires invite code to find
  PRIVATE
}

// =============================================================================
// Multi-Tenancy Models
// =============================================================================
// ClubUser links users to clubs with roles.
// Tier defines feature limits for clubs.
// AccessRequest tracks join requests.

/// User's access to a club (junction table).
/// A user can belong to multiple clubs with different roles.
model ClubUser {
  id String @id @default(cuid())

  /// The user who has access
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// The club being accessed
  clubId String
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  /// Roles within this club (1:n relationship, empty = no access)
  roles ClubRole[]

  /// Status of the user's access
  status ClubUserStatus @default(ACTIVE)

  /// When the user joined this club
  joinedAt DateTime @default(now())

  /// Who invited this user (optional)
  invitedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, clubId])
  @@index([clubId])
  @@index([userId])
  @@map("club_users")
}

/// Roles a user can have within a club (multiple roles per user possible)
enum ClubRole {
  /// Full control, all permissions
  OWNER
  /// Technical administration, user management (no finance access)
  ADMIN
  /// Financial features: bookkeeping, fees, SEPA, reports (no user management)
  TREASURER
  /// Protocols, documentation, board member
  SECRETARY
  /// Basic member access
  MEMBER
}

/// Status of a user's club membership
enum ClubUserStatus {
  /// Active access
  ACTIVE
  /// Invitation pending acceptance
  PENDING
  /// Access temporarily suspended
  SUSPENDED
}

/// Request for access to a club (for PUBLIC clubs or via invite code).
/// Requires admin approval.
model AccessRequest {
  id String @id @default(cuid())

  /// The user requesting access
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// The club being requested
  clubId String
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  /// Optional message from the requester (max 500 chars)
  message String?

  /// Current status of the request
  status AccessRequestStatus @default(PENDING)

  /// Rejection handling
  rejectionReason AccessRejectionReason?
  /// Custom note for "OTHER" reason
  rejectionNote   String?
  /// Who processed this request
  processedById   String?
  /// When this request was processed
  processedAt     DateTime?
  /// When the user acknowledged seeing the rejection (null = not yet seen)
  seenAt          DateTime?

  /// Request expires after 30 days
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, clubId])
  @@index([clubId])
  @@index([userId])
  @@map("access_requests")
}

/// Status of an access request
enum AccessRequestStatus {
  /// Awaiting admin review
  PENDING
  /// Admin approved, user now has access
  APPROVED
  /// Admin rejected the request
  REJECTED
  /// Request expired without action
  EXPIRED
}

/// Reason for rejecting an access request
enum AccessRejectionReason {
  /// "Nur Vorstandsmitglieder haben Zugang"
  BOARD_ONLY
  /// "Wir konnten dich leider nicht zuordnen"
  UNIDENTIFIED
  /// "Das scheint nicht der richtige Verein zu sein"
  WRONG_CLUB
  /// "Bitte kontaktiere uns direkt"
  CONTACT_DIRECTLY
  /// Custom reason in rejectionNote
  OTHER
}

/// Tier/plan for clubs with feature flags and limits.
/// Supports future SaaS billing integration.
model Tier {
  id String @id @default(cuid())

  /// Display name of the tier
  name String @unique

  /// Description of what's included
  description String?

  /// Whether this tier is visible to users
  isVisible Boolean @default(true)

  /// Cannot be deleted if true (seeded tiers)
  isSeeded Boolean @default(false)

  /// Display order in tier selection
  sortOrder Int @default(0)

  /// Preset color name for display
  color String?

  /// Lucide icon name for display
  icon String?

  /// Limits (null = unlimited)
  /// Maximum users per club
  usersLimit   Int?
  /// Maximum members per club
  membersLimit Int?
  /// Storage limit in MB
  storageLimit Int?

  /// Feature flags
  /// SEPA direct debit enabled
  sepaEnabled       Boolean @default(true)
  /// Financial reports enabled
  reportsEnabled    Boolean @default(true)
  /// Bank statement import enabled
  bankImportEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Clubs on this tier
  clubs Club[]

  @@map("tiers")
}

// =============================================================================
// System Configuration
// =============================================================================

/// System-wide application settings (key-value store).
/// Used for configuration that doesn't belong to a specific club.
model AppSetting {
  /// Setting key (unique identifier)
  key String @id

  /// JSON-serialized value
  value String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

/// Audit log for tracking changes to entities.
/// Per ADR-0010: Row-Level Tenant Isolation.
model AuditLog {
  id String @id @default(cuid())

  /// Model name (e.g., "Club", "Member")
  entityType String

  /// ID of the affected entity
  entityId String

  /// Operation performed (create, update, delete)
  action String

  /// Who performed the action (null for system actions)
  userId String?

  /// Club context if applicable
  clubId String?

  /// What changed (before/after or input data)
  changes Json?

  /// Client IP address
  ipAddress String?

  /// Client user agent
  userAgent String?

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([clubId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// Member Management Models (Phase 10)
// =============================================================================
// Member CRUD, status lifecycle, household grouping, membership periods,
// and Nummernkreise (number ranges) infrastructure.

/// Status of a club member
enum MemberStatus {
  /// Currently active member with full privileges
  ACTIVE
  /// Temporarily inactive (e.g., sabbatical, Ruhende Mitgliedschaft)
  INACTIVE
  /// Application pending approval
  PENDING
  /// Left the club (historical record, terminal state)
  LEFT
}

/// Type of person (natural person vs. legal entity like company/organization)
enum PersonType {
  /// Natural person (natuerliche Person)
  NATURAL
  /// Legal entity (juristische Person, e.g., company, organization)
  LEGAL_ENTITY
}

/// Salutation for member correspondence (German conventions)
enum Salutation {
  /// Herr
  HERR
  /// Frau
  FRAU
  /// Divers
  DIVERS
}

/// Type of membership within a period
enum MembershipType {
  /// Ordentliches Mitglied (full member with voting rights)
  ORDENTLICH
  /// Passives Mitglied (no active participation, reduced duties)
  PASSIV
  /// Ehrenmitglied (honorary member, typically fee-exempt)
  EHREN
  /// Foerdermitglied (supporting member, financial support only)
  FOERDER
  /// Jugendmitglied (youth member, age-based)
  JUGEND
}

/// Role of a member within a household
enum HouseholdRole {
  /// Head of household (Haushaltsvorstand), primary contact
  HEAD
  /// Spouse/partner (Ehepartner/Lebenspartner)
  SPOUSE
  /// Child (Kind)
  CHILD
  /// Other household member (Sonstige)
  OTHER
}

/// Reason for soft-deleting a member record
enum DeletionReason {
  /// Voluntary departure (Austritt)
  AUSTRITT
  /// Exclusion by board decision (Ausschluss)
  AUSSCHLUSS
  /// DSGVO/GDPR data deletion request (Datenschutz)
  DATENSCHUTZ
  /// Other reason (Sonstiges)
  SONSTIGES
}

/// A member of a club with contact information and membership details.
/// Members belong to exactly one club (tenant isolation).
/// Supports both natural persons and legal entities (Personenart).
model Member {
  /// Unique identifier (CUID format)
  id     String @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId String
  /// The club this member belongs to
  club   Club   @relation(fields: [clubId], references: [id])

  /// Member number (unique per club, alphanumeric, e.g., "TSV-001")
  memberNumber String

  /// Person type: natural person or legal entity
  personType PersonType @default(NATURAL)

  // --- Name fields (natural person) ---
  /// Salutation (Anrede): Herr, Frau, Divers
  salutation Salutation?
  /// Academic or professional title (e.g., Dr., Prof. Dr.)
  title      String?
  /// First name (Vorname) - required
  firstName  String
  /// Last name (Nachname) - required
  lastName   String
  /// Nickname or club name (Spitzname/Clubname)
  nickname   String?

  // --- Legal entity fields ---
  /// Organization name (required for LEGAL_ENTITY)
  organizationName String?
  /// Contact person first name
  contactFirstName String?
  /// Contact person last name
  contactLastName  String?
  /// Department within the organization
  department       String?
  /// Position/role within the organization
  position         String?
  /// VAT ID / Steuernummer
  vatId            String?

  // --- Address (structured for SEPA pain.008 compliance) ---
  /// Street name (Strasse)
  street       String?
  /// House number including suffixes (e.g., "42a", "7-9")
  houseNumber  String?
  /// Address supplement (c/o, Apartment, Hinterhaus)
  addressExtra String?
  /// Postal code (PLZ, 5-digit for Germany)
  postalCode   String?
  /// City (Ort)
  city         String?
  /// Country (ISO 3166-1 alpha-2, default "DE")
  country      String  @default("DE")

  // --- Contact ---
  /// Email address for club communication (independent of User login email)
  email  String?
  /// Phone number (landline or general)
  phone  String?
  /// Mobile phone number
  mobile String?
  /// Free-text notes (additional information, preferred contact method, etc.)
  notes  String?

  // --- Status lifecycle ---
  /// Current membership status (PENDING -> ACTIVE -> INACTIVE/LEFT)
  status             MemberStatus @default(PENDING)
  /// When the status was last changed
  statusChangedAt    DateTime?
  /// User ID who changed the status
  statusChangedBy    String?
  /// Reason for the last status change (visible in timeline)
  statusChangeReason String?
  /// Date when membership WILL end (Kuendigungsdatum, date-only to avoid TZ issues)
  cancellationDate       DateTime? @db.Date
  /// When the club received the cancellation notice (Kuendigungseingang)
  cancellationReceivedAt DateTime?

  // --- DSGVO / GDPR ---
  /// Date when DSGVO deletion was requested (date-only)
  dsgvoRequestDate DateTime? @db.Date
  /// When personal data was anonymized (irreversible)
  anonymizedAt     DateTime?
  /// User ID who performed the anonymization
  anonymizedBy     String?

  // --- User linking ---
  /// Link to application User account (nullable, set by OWNER/SECRETARY)
  userId String?

  // --- Household ---
  /// Household this member belongs to
  householdId   String?
  /// Relation to household entity
  household     Household?     @relation(fields: [householdId], references: [id])
  /// Role within the household
  householdRole HouseholdRole?

  // --- Soft deletion (CONV-006) ---
  /// Soft deletion timestamp
  deletedAt      DateTime?
  /// User ID who performed the soft deletion
  deletedBy      String?
  /// Reason for deletion
  deletionReason DeletionReason?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  /// Membership periods (supports re-entry with multiple periods)
  membershipPeriods MembershipPeriod[]

  @@unique([clubId, memberNumber])
  @@index([clubId])
  @@index([clubId, lastName])
  @@index([clubId, status])
  @@map("members")
}

/// A household groups related members (e.g., family).
/// Address lives on each member individually for independence.
/// SEWOBE-style model with roles and primary contact.
model Household {
  /// Unique identifier (CUID format)
  id     String @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId String
  /// The club this household belongs to
  club   Club   @relation(fields: [clubId], references: [id])

  /// Household name/label (e.g., "Familie Mustermann")
  name             String
  /// ID of the primary contact member (HEAD)
  primaryContactId String?

  /// Soft deletion timestamp
  deletedAt DateTime?
  /// User ID who performed the soft deletion
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Members belonging to this household
  members Member[]

  @@index([clubId])
  @@map("households")
}

/// A membership period represents a continuous span of membership.
/// Supports re-entry: a member can have multiple non-overlapping periods.
/// Membership type (Mitgliedsart) lives here, not on Member, to allow type changes.
model MembershipPeriod {
  /// Unique identifier (CUID format)
  id       String @id @default(cuid())
  /// Reference to the member
  memberId String
  /// The member this period belongs to
  member   Member @relation(fields: [memberId], references: [id])

  /// Date when this membership period started (date-only, inclusive)
  joinDate       DateTime       @db.Date
  /// Date when this membership period ended (date-only, inclusive, null = current)
  leaveDate      DateTime?      @db.Date
  /// Type of membership during this period
  membershipType MembershipType
  /// Optional notes about this period
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@map("membership_periods")
}

/// Reusable number range infrastructure for sequential number generation.
/// Used for member numbers (Phase 10), transaction numbers (Phase 13),
/// SEPA mandate references (Phase 16).
/// Pattern: {prefix}{zero-padded sequential} with optional {YYYY} placeholder.
model NumberRange {
  /// Unique identifier (CUID format)
  id     String @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId String
  /// The club this number range belongs to
  club   Club   @relation(fields: [clubId], references: [id])

  /// Entity type this range is for (e.g., 'MEMBER', 'TRANSACTION', 'SEPA_MANDATE')
  entityType   String
  /// Prefix for generated numbers (may contain {YYYY} placeholder)
  prefix       String  @default("")
  /// Current counter value (atomically incremented)
  currentValue Int     @default(0)
  /// Number of digits to pad to (e.g., 4 -> "0001")
  padLength    Int     @default(4)
  /// Whether to reset counter at year boundary
  yearReset    Boolean @default(false)
  /// Year of last counter reset (used for year-reset detection, avoids updatedAt ambiguity)
  lastResetYear Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clubId, entityType])
  @@index([clubId])
  @@map("number_ranges")
}

/// Type of account in the chart of accounts (SKR42)
enum AccountType {
  /// Assets (Aktivkonten) - Class 0-1
  ASSET
  /// Liabilities (Passivkonten) - Class 2-3
  LIABILITY
  /// Income (Ertragskonten) - Class 4
  INCOME
  /// Expense (Aufwandskonten) - Class 5-8
  EXPENSE
}

/// An account in the chart of accounts (Kontenrahmen).
/// Based on SKR42 for German non-profit organizations.
/// Named LedgerAccount to avoid conflict with Better Auth's Account model.
model LedgerAccount {
  /// Unique identifier (CUID format)
  id     String @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId String
  /// The club this account belongs to
  club   Club   @relation(fields: [clubId], references: [id])

  /// SKR42 account code (e.g., "1200" for Bank)
  code String
  /// Account name/description
  name String
  /// Type of account (asset, liability, income, expense)
  type AccountType

  /// Whether this account is active and can receive postings
  isActive Boolean @default(true)

  /// Soft deletion timestamp
  deletedAt DateTime?
  /// User ID who performed the soft deletion
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clubId, code])
  @@index([clubId])
  @@map("ledger_accounts")
}

// =============================================================================
// Authentication Models (Better Auth)
// =============================================================================
// These models support Better Auth with Prisma adapter.
// User externalId preserved for future Zitadel migration.
// Reference: https://www.better-auth.com/docs/adapters/prisma

/// Application user. Managed by Better Auth.
/// Soft-deletion supported per CONV-006.
model User {
  id String @id @default(cuid())

  /// External ID for future Zitadel migration (OIDC profile.sub claim)
  externalId String? @unique

  /// User's email address (from registration or OAuth)
  email String @unique

  /// Whether email has been verified
  emailVerified Boolean @default(false)

  /// Display name (from registration or OAuth profile)
  name String?

  /// Profile image URL (from OAuth provider or uploaded)
  image String?

  /// System-wide super admin flag (first user gets this automatically)
  isSuperAdmin Boolean @default(false)

  /// Terms & Conditions acceptance timestamp
  termsAcceptedAt DateTime?

  /// Soft-deletion fields (CONV-006)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  deletedBy String?

  /// Better Auth relations
  accounts Account[]
  sessions Session[]

  /// Multi-tenancy relations
  clubUsers      ClubUser[]
  accessRequests AccessRequest[]

  @@map("auth_users")
}

/// Auth account linked to a user (Better Auth adapter requirement)
/// Stores credentials and provider info for each auth method
model Account {
  id     String @id @default(cuid())
  userId String

  /// Provider identifier (e.g., "credential", "google", "github")
  providerId String

  /// Provider's account ID (user ID at provider, or internal ID for credentials)
  accountId String

  /// Password hash for credential provider (scrypt format)
  password String?

  /// OAuth tokens
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?

  /// Token metadata
  scope   String?
  idToken String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("auth_accounts")
}

/// User session (Better Auth adapter requirement)
/// Database-backed sessions for revocation support
model Session {
  id String @id @default(cuid())

  /// Session token for cookie validation
  token String @unique

  /// User who owns this session
  userId String

  /// When the session expires
  expiresAt DateTime

  /// Client metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth_sessions")
}

/// Email verification token (Better Auth)
/// Used for email verification and password reset
model Verification {
  id String @id @default(cuid())

  /// What is being verified (email address, phone, etc.)
  identifier String

  /// The verification token/code
  value String

  /// When this verification expires
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("auth_verifications")
}
