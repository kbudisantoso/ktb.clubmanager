// ktb.clubmanager Database Schema
// Documentation: docs/schema/

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// A club or organization managed by the system (tenant).
/// Each club is completely isolated - members, accounts, and transactions
/// belong to exactly one club.
model Club {
  /// Unique identifier (CUID format)
  id          String    @id @default(cuid())
  /// Display name of the club
  name        String
  /// Optional description or notes about the club
  description String?

  /// Soft deletion timestamp (null if not deleted)
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  members     Member[]
  accounts    Account[]

  @@map("clubs")
}

/// Status of a club member
enum MemberStatus {
  /// Currently active member with full privileges
  ACTIVE
  /// Temporarily inactive (e.g., sabbatical)
  INACTIVE
  /// Application pending approval
  PENDING
  /// Left the club (historical record)
  LEFT
}

/// A member of a club with contact information and membership details.
/// Members belong to exactly one club (tenant isolation).
model Member {
  /// Unique identifier (CUID format)
  id          String       @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId      String
  /// The club this member belongs to
  club        Club         @relation(fields: [clubId], references: [id])

  /// Member's full name
  name        String
  /// Email address (unique within club)
  email       String?
  /// Phone number
  phone       String?

  /// Street address
  street      String?
  /// Postal/ZIP code
  postalCode  String?
  /// City
  city        String?

  /// Current membership status
  status      MemberStatus @default(ACTIVE)
  /// Date when member joined the club
  joinedAt    DateTime?
  /// Date when member left (if status is LEFT)
  leftAt      DateTime?

  /// Soft deletion timestamp
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([clubId, email])
  @@index([clubId])
  @@map("members")
}

/// Type of account in the chart of accounts (SKR42)
enum AccountType {
  /// Assets (Aktivkonten) - Class 0-1
  ASSET
  /// Liabilities (Passivkonten) - Class 2-3
  LIABILITY
  /// Income (Ertragskonten) - Class 4
  INCOME
  /// Expense (Aufwandskonten) - Class 5-8
  EXPENSE
}

/// An account in the chart of accounts (Kontenrahmen).
/// Based on SKR42 for German non-profit organizations.
model Account {
  /// Unique identifier (CUID format)
  id          String      @id @default(cuid())
  /// Reference to the parent club (tenant)
  clubId      String
  /// The club this account belongs to
  club        Club        @relation(fields: [clubId], references: [id])

  /// SKR42 account code (e.g., "1200" for Bank)
  code        String
  /// Account name/description
  name        String
  /// Type of account (asset, liability, income, expense)
  type        AccountType

  /// Whether this account is active and can receive postings
  isActive    Boolean     @default(true)

  /// Soft deletion timestamp
  deletedAt   DateTime?
  /// User ID who performed the soft deletion
  deletedBy   String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([clubId, code])
  @@index([clubId])
  @@map("accounts")
}

// =============================================================================
// Authentication Models (Better Auth)
// =============================================================================
// These models support Better Auth with Prisma adapter.
// User externalId preserved for future Zitadel migration.
// Reference: https://www.better-auth.com/docs/adapters/prisma

/// Application user. Managed by Better Auth.
/// Soft-deletion supported per CONV-006.
model User {
  id            String    @id @default(cuid())

  /// External ID for future Zitadel migration (OIDC profile.sub claim)
  externalId    String?   @unique

  /// User's email address (from registration or OAuth)
  email         String    @unique

  /// Whether email has been verified
  emailVerified Boolean   @default(false)

  /// Display name (from registration or OAuth profile)
  name          String?

  /// Profile image URL (from OAuth provider or uploaded)
  image         String?

  /// Terms & Conditions acceptance timestamp
  termsAcceptedAt DateTime?

  /// Password hash for email/password auth (bcrypt)
  /// Null for OAuth-only users
  passwordHash  String?

  /// Soft-deletion fields (CONV-006)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  deletedBy     String?

  /// Better Auth relations
  accounts      OAuthAccount[]
  sessions      Session[]

  @@map("users")
}

/// OAuth account linked to a user (Better Auth adapter requirement)
/// Stores tokens and provider info for each linked OAuth account
/// Note: Named OAuthAccount to avoid conflict with Chart of Accounts model
model OAuthAccount {
  id                String    @id @default(cuid())
  userId            String

  /// Provider identifier (e.g., "google", "github")
  providerId        String

  /// Provider's account ID (user ID at provider)
  accountId         String

  /// OAuth tokens
  accessToken       String?   @db.Text
  refreshToken      String?   @db.Text
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?

  /// Token metadata
  scope             String?
  idToken           String?   @db.Text

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("oauth_accounts")
}

/// User session (Better Auth adapter requirement)
/// Database-backed sessions for revocation support
model Session {
  id           String   @id @default(cuid())

  /// Session token for cookie validation
  token        String   @unique

  /// User who owns this session
  userId       String

  /// When the session expires
  expiresAt    DateTime

  /// Client metadata
  ipAddress    String?
  userAgent    String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// Email verification token (Better Auth)
/// Used for email verification and password reset
model Verification {
  id         String   @id @default(cuid())

  /// What is being verified (email address, phone, etc.)
  identifier String

  /// The verification token/code
  value      String

  /// When this verification expires
  expiresAt  DateTime

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}
